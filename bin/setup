#!/bin/sh

# Exit if any subcommand fails
set -e

# Set up Ruby dependencies via Bundler
gem install bundler --conservative
bundle check || bundle install

git restore -s@ -SW spec/dummy

cd spec/dummy
git clean -f -d
rake db:setup
if [ "$1" = "--use_webpacker" ]; then
  bundle exec rails webpacker:install
  bundle exec rails generate active_admin:install --skip-users --skip-comments --use_webpacker
else
  set +e
  yarn remove @activeadmin/activeadmin @rails/webpacker activeadmin_addons webpack-dev-server
  set -e
  bundle exec rails generate active_admin:install --skip-users --skip-comments
fi
bundle exec rails g activeadmin_addons:install

if [ "$1" = "--use_webpacker" ]; then
  yarn add file:./../..
fi
